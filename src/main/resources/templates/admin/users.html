<!-- src/main/resources/templates/admin/users.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head('Gestión de Usuarios')"></head>
<body>
<header th:replace="fragments/header :: header"></header>

<main class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gestión de Usuarios</h1>
        <a th:href="@{/admin}" class="btn btn-outline-primary">Volver al Dashboard</a>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-0">Buscar Usuarios</h5>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <input type="text" id="search-input" class="form-control" placeholder="Buscar por nombre o email...">
                </div>
                <div class="col-md-4 mb-3">
                    <select id="role-filter" class="form-select">
                        <option value="">Todos los roles</option>
                        <option value="ROLE_ADMIN">Administrador</option>
                        <option value="ROLE_CLIENT">Cliente</option>
                    </select>
                </div>
            </div>
            <div class="text-end">
                <button id="search-btn" class="btn btn-primary">Buscar</button>
                <button id="clear-search-btn" class="btn btn-outline-secondary">Limpiar</button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>
    </div>

    <!-- Modal para ver detalles del usuario -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles del Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="user-details">
                        <p><strong>ID:</strong> <span id="user-id"></span></p>
                        <p><strong>Usuario:</strong> <span id="user-username"></span></p>
                        <p><strong>Nombre:</strong> <span id="user-fullname"></span></p>
                        <p><strong>Email:</strong> <span id="user-email"></span></p>
                        <p><strong>Dirección:</strong> <span id="user-address"></span></p>
                        <p><strong>Teléfono:</strong> <span id="user-phone"></span></p>
                        <p><strong>Rol:</strong> <span id="user-role"></span></p>
                        <p><strong>Estado:</strong> <span id="user-status"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="fragments/footer :: footer"></footer>

<script>
// --- Búsqueda dinámica con debounce para gestión de usuarios ---
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const roleFilter = document.getElementById('role-filter');
    const tableBody = document.getElementById('table-body');
    let debounceTimeout;

    function renderUsers(users) {
        tableBody.innerHTML = '';
        if (users.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron usuarios.</td></tr>';
            return;
        }
        users.forEach(user => {
            tableBody.innerHTML += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.fullName || ''}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'ROLE_ADMIN' ? 'bg-danger' : 'bg-info'}">${user.role === 'ROLE_ADMIN' ? 'Administrador' : 'Cliente'}</span></td>
                    <td><span class="badge ${user.enabled ? 'bg-success' : 'bg-danger'}">${user.enabled ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary view-user" data-id="${user.id}">Ver</button>
                            ${user.role === 'ROLE_CLIENT' ? `<button type="button" class="btn btn-outline-warning toggle-status" data-id="${user.id}" data-status="${user.enabled}"><span>${user.enabled ? 'Desactivar' : 'Activar'}</span></button>` : ''}
                        </div>
                    </td>
                </tr>`;
        });
        // Registrar eventos después de renderizar la tabla
        tableBody.querySelectorAll('.view-user').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-id');
                const user = users.find(u => u.id == userId);
                if (user) {
                    document.getElementById('user-id').textContent = user.id;
                    document.getElementById('user-username').textContent = user.username;
                    document.getElementById('user-fullname').textContent = user.fullName || '';
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('user-address').textContent = user.address || '';
                    document.getElementById('user-phone').textContent = user.phone || '';
                    document.getElementById('user-role').textContent = user.role === 'ROLE_ADMIN' ? 'Administrador' : 'Cliente';
                    document.getElementById('user-status').textContent = user.enabled ? 'Activo' : 'Inactivo';
                    const modal = new bootstrap.Modal(document.getElementById('userModal'));
                    modal.show();
                }
            });
        });
        // Evento para activar/desactivar cliente
        tableBody.querySelectorAll('.toggle-status').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-id');
                const currentStatus = this.getAttribute('data-status') === 'true';
                fetch(`/api/users/${userId}/enabled`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentStatus })
                })
                .then(res => {
                    if (!res.ok) throw new Error('Error al cambiar el estado');
                    return res.json();
                })
                .then(() => fetchUsersLive())
                .catch(() => alert('No se pudo cambiar el estado del usuario.'));
            });
        });
    }

    function getRoleValue() {
        const val = roleFilter.value;
        if (val === 'ROLE_CLIENT' || val === 'ROLE_ADMIN') return val;
        return '';
    }

    function fetchUsersLive(loadAll) {
        let url = '/api/users/search?';
        const query = searchInput.value.trim();
        const role = getRoleValue();
        if (!loadAll) {
            if (query) url += `query=${encodeURIComponent(query)}&`;
            if (role) url += `role=${encodeURIComponent(role)}`;
        }
        fetch(url)
            .then(res => res.json())
            .then(renderUsers)
            .catch(() => {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al buscar usuarios.</td></tr>';
            });
    }

    // Cuando la barra está vacía y el filtro es "Todos", muestra todos los usuarios
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(function() {
            if (!searchInput.value.trim() && !getRoleValue()) {
                fetchUsersLive(true);
            } else {
                fetchUsersLive();
            }
        }, 350);
    });
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            if (!searchInput.value.trim() && !getRoleValue()) {
                fetchUsersLive(true);
            } else {
                fetchUsersLive();
            }
        }
    });
    roleFilter.addEventListener('change', function() {
        if (!searchInput.value.trim() && !getRoleValue()) {
            fetchUsersLive(true);
        } else {
            fetchUsersLive();
        }
    });
    document.getElementById('search-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (!searchInput.value.trim() && !getRoleValue()) {
            fetchUsersLive(true);
        } else {
            fetchUsersLive();
        }
    });
    document.getElementById('clear-search-btn').addEventListener('click', function(e) {
        e.preventDefault();
        searchInput.value = '';
        roleFilter.value = '';
        fetchUsersLive(true);
    });
    // Al cargar la página, muestra todos los usuarios
    fetchUsersLive(true);
});
// --- Fin búsqueda dinámica ---
</script>
</body>
</html>
